---
import { company } from '../data/company';

const pathname = Astro.url.pathname;

const isActive = (href: string) => {
	if (href === '/') return pathname === '/';
	return pathname === href || pathname.startsWith(`${href}/`);
};
---

<header
	class="sticky top-0 z-40 border-b bg-[rgb(var(--color-bg)/0.78)] backdrop-blur"
	style="border-color: rgb(var(--color-border) / 0.12); box-shadow: 0 1px 0 rgb(var(--color-border) / 0.06);"
>
	<div class="mx-auto flex h-[72px] w-full max-w-[1100px] items-center justify-between gap-3 px-4">
		<a class="flex items-center gap-3 no-underline" href="/">
			<span
				class="grid h-9 w-9 place-items-center rounded-xl text-white"
				style="background: linear-gradient(135deg, rgb(var(--color-primary)), rgb(var(--color-accent)));"
				aria-hidden="true"
			>
				<span class="text-sm font-semibold tracking-tight">C</span>
			</span>
			<span class="leading-tight">
				<span class="block text-sm font-semibold tracking-tight text-[rgb(var(--color-text))]">CAMS</span>
				<span class="block text-xs text-[rgb(var(--color-muted))]">{company.officeLabel}</span>
			</span>
		</a>

		<nav
			class="hidden rounded-2xl border bg-[rgb(var(--color-surface))] p-1 md:flex"
			style="border-color: rgb(var(--color-border) / 0.12);"
			aria-label="Hauptnavigation"
		>
			{company.navigation.main.map((item) => (
				<a
					class={`nav-link ${isActive(item.href) ? 'nav-link-active' : ''}`}
					href={item.href}
					aria-current={isActive(item.href) ? 'page' : undefined}
				>
					{item.label}
				</a>
			))}
		</nav>

		<div class="hidden items-center gap-3 md:flex">
			<button
				type="button"
				class="icon-btn inline-flex items-center justify-center"
				aria-label="Darkmode umschalten"
				data-theme-toggle
			>
				<span class="sr-only" data-theme-label>Zum Darkmode wechseln</span>
				<svg
					data-theme-icon-sun
					width="18"
					height="18"
					viewBox="0 0 24 24"
					fill="none"
					xmlns="http://www.w3.org/2000/svg"
					aria-hidden="true"
				>
					<path
						d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z"
						stroke="currentColor"
						stroke-width="2"
						stroke-linecap="round"
						stroke-linejoin="round"
					/>
					<path
						d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"
						stroke="currentColor"
						stroke-width="2"
						stroke-linecap="round"
						stroke-linejoin="round"
					/>
				</svg>
				<svg
					data-theme-icon-moon
					class="hidden"
					width="18"
					height="18"
					viewBox="0 0 24 24"
					fill="none"
					xmlns="http://www.w3.org/2000/svg"
					aria-hidden="true"
				>
					<path
						d="M21 13.2A8.4 8.4 0 0 1 10.8 3a6.6 6.6 0 1 0 10.2 10.2Z"
						stroke="currentColor"
						stroke-width="2"
						stroke-linecap="round"
						stroke-linejoin="round"
					/>
				</svg>
			</button>
			<a
				class="btn btn-primary px-4 py-2"
				style="background: linear-gradient(135deg, rgb(var(--color-primary)), rgb(var(--color-accent)));"
				href={company.navigation.cta.href}
			>
				{company.navigation.cta.label}
			</a>
		</div>

		<!-- Mobile menu -->
		<button type="button" class="md:hidden icon-btn inline-flex items-center justify-center" aria-label="Menü öffnen" data-nav-open>
			<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
				<path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
			</svg>
		</button>
	</div>
</header>

<div class="nav-overlay md:hidden" data-nav-overlay aria-hidden="true">
	<div class="nav-backdrop" data-nav-close aria-hidden="true"></div>
	<div class="nav-sheet" role="dialog" aria-modal="true" aria-label="Navigation">
		<div class="flex items-center justify-between">
			<div class="text-sm font-semibold text-[rgb(var(--color-text))]">{company.name}</div>
			<button type="button" class="icon-btn inline-flex items-center justify-center" aria-label="Menü schließen" data-nav-close>
				<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
					<path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
				</svg>
			</button>
		</div>

		<nav class="mt-10 grid gap-2" aria-label="Mobile Navigation">
			{company.navigation.main.map((item) => (
				<a class={`nav-mobile-link ${isActive(item.href) ? 'nav-mobile-link-active' : ''}`} href={item.href} data-nav-link>
					{item.label}
				</a>
			))}
			<a class="nav-mobile-link" href={company.navigation.cta.href} data-nav-link>
				{company.navigation.cta.label}
			</a>
		</nav>

		<div class="mt-10 grid gap-3">
			<div class="rounded-2xl border p-4 text-sm text-[rgb(var(--color-muted))]" style="border-color: rgb(var(--color-border) / 0.12);">
				<div class="text-xs font-semibold uppercase tracking-wide text-[rgb(var(--color-text))]">Kontakt</div>
				<div class="mt-2">
					<a class="no-underline hover:opacity-80" href={`tel:${company.contact.phoneHref}`}>
						{company.contact.phone}
					</a>
				</div>
				<div class="mt-1">
					<a class="no-underline hover:opacity-80" href={`mailto:${company.contact.email}`}>
						{company.contact.email}
					</a>
				</div>
			</div>

			<button type="button" class="btn btn-secondary w-full" aria-label="Darkmode umschalten" data-theme-toggle>
				<span class="sr-only" data-theme-label>Zum Darkmode wechseln</span>
				<span class="inline-flex items-center gap-2">
					<span class="text-sm font-medium" data-theme-toggle-text>Darkmode</span>
				</span>
			</button>

			<a
				class="btn btn-primary w-full"
				style="background: linear-gradient(135deg, rgb(var(--color-primary)), rgb(var(--color-accent)));"
				href={company.navigation.cta.href}
				data-nav-link
			>
				Kontakt aufnehmen
			</a>
		</div>
	</div>
</div>

<style>
	.nav-link {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		padding: 10px 14px;
		border-radius: 14px;
		font-size: 14px;
		font-weight: 600;
		color: rgb(var(--color-muted));
		text-decoration: none;
		transition: background 0.15s ease, color 0.15s ease, transform 0.15s ease;
	}

	.nav-link:hover {
		color: rgb(var(--color-text));
		background: rgb(var(--color-bg));
	}

	.nav-link-active {
		color: rgb(var(--color-text));
		background: rgb(var(--color-bg));
	}

	.icon-btn {
		height: 40px;
		width: 40px;
		border-radius: 14px;
		border: 1px solid rgb(var(--color-border) / 0.12);
		background: rgb(var(--color-surface));
		color: rgb(var(--color-text));
		transition: transform 0.15s ease, opacity 0.15s ease;
	}

	.icon-btn:hover {
		opacity: 0.92;
	}

	.nav-overlay {
		position: fixed;
		inset: 0;
		z-index: 60;
		pointer-events: none;
		opacity: 0;
		transition: opacity 0.18s ease;
	}

	.nav-overlay[data-open='true'] {
		pointer-events: auto;
		opacity: 1;
	}

	.nav-backdrop {
		position: absolute;
		inset: 0;
		background: rgb(0 0 0 / 0.45);
	}

	.nav-sheet {
		position: absolute;
		inset: 10px;
		border-radius: 22px;
		background: rgb(var(--color-bg));
		border: 1px solid rgb(var(--color-border) / 0.12);
		padding: 18px;
		transform: translateY(16px) scale(0.98);
		opacity: 0;
		transition: transform 0.18s ease, opacity 0.18s ease;
		box-shadow: 0 24px 80px rgb(0 0 0 / 0.25);
	}

	.nav-overlay[data-open='true'] .nav-sheet {
		transform: translateY(0) scale(1);
		opacity: 1;
	}

	.nav-mobile-link {
		display: flex;
		align-items: center;
		justify-content: space-between;
		padding: 14px 14px;
		border-radius: 16px;
		border: 1px solid rgb(var(--color-border) / 0.10);
		background: rgb(var(--color-surface));
		color: rgb(var(--color-text));
		text-decoration: none;
		font-size: 16px;
		font-weight: 600;
	}

	.nav-mobile-link-active {
		border-color: rgb(var(--color-accent) / 0.35);
		box-shadow: 0 0 0 3px rgb(var(--color-accent) / 0.12);
	}
 </style>

<script is:inline>
	(() => {
		const storageKey = 'theme';
		const root = document.documentElement;
		const buttons = Array.from(document.querySelectorAll('[data-theme-toggle]'));
		const labels = Array.from(document.querySelectorAll('[data-theme-label]'));
		const toggleTexts = Array.from(document.querySelectorAll('[data-theme-toggle-text]'));
		const iconSun = document.querySelector('[data-theme-icon-sun]');
		const iconMoon = document.querySelector('[data-theme-icon-moon]');

		const getTheme = () => (root.classList.contains('dark') ? 'dark' : 'light');
		const setTheme = (theme) => {
			root.classList.toggle('dark', theme === 'dark');
			localStorage.setItem(storageKey, theme);
			const nextLabel = theme === 'dark' ? 'Hellmodus' : 'Darkmode';
			const nextA11y = theme === 'dark' ? 'Zum Hellmodus wechseln' : 'Zum Darkmode wechseln';
			labels.forEach((el) => (el.textContent = nextA11y));
			toggleTexts.forEach((el) => (el.textContent = nextLabel));

			// show the icon for the *next* action: light->moon, dark->sun
			if (iconSun instanceof SVGElement) iconSun.classList.toggle('hidden', theme !== 'dark');
			if (iconMoon instanceof SVGElement) iconMoon.classList.toggle('hidden', theme !== 'light');
		};

		// initialize labels from current state (set early in Layout)
		setTheme(getTheme());

		buttons.forEach((btn) => {
			btn.addEventListener('click', () => {
				const next = getTheme() === 'dark' ? 'light' : 'dark';
				setTheme(next);
			});
		});
	})();
</script>

<script is:inline>
	(() => {
		const overlay = document.querySelector('[data-nav-overlay]');
		const openBtn = document.querySelector('[data-nav-open]');
		const closeBtns = Array.from(document.querySelectorAll('[data-nav-close]'));
		const linkBtns = Array.from(document.querySelectorAll('[data-nav-link]'));

		if (!(overlay instanceof HTMLElement)) return;
		if (!(openBtn instanceof HTMLElement)) return;

		let lastActive = null;

		const setOpen = (open) => {
			overlay.dataset.open = open ? 'true' : 'false';
			overlay.setAttribute('aria-hidden', open ? 'false' : 'true');
			document.body.style.overflow = open ? 'hidden' : '';
			if (open) {
				lastActive = document.activeElement;
				const close = overlay.querySelector('[data-nav-close]');
				if (close instanceof HTMLElement) close.focus();
			} else {
				if (lastActive instanceof HTMLElement) lastActive.focus();
			}
		};

		openBtn.addEventListener('click', () => setOpen(true));
		closeBtns.forEach((b) => b.addEventListener('click', () => setOpen(false)));
		linkBtns.forEach((a) => a.addEventListener('click', () => setOpen(false)));

		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape' && overlay.dataset.open === 'true') setOpen(false);
		});

		// init closed
		setOpen(false);
	})();
</script>


