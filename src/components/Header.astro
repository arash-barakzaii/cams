---
import { company } from '../data/company';
import logoImg from '../assets/CAMS_weiß.svg';
import logoWhite from '../assets/CAMS_weiß.svg';
import logoSchwarz from '../assets/CAMS_Schwarz.svg';


interface Props {
	transparent?: boolean;
}
const { transparent = false } = Astro.props;

const pathname = Astro.url.pathname;

const isActive = (href: string) => {
	if (href === '/') return pathname === '/';
	return pathname === href || pathname.startsWith(`${href}/`);
};
---

<header
	class:list={[
		"fixed top-0 left-0 w-full z-40 transition-colors duration-300",
		transparent 
			? "bg-transparent border-transparent text-white" 
			: "bg-[rgb(var(--color-bg)/0.95)] backdrop-blur border-b border-[rgb(var(--color-border)/0.12)] text-[rgb(var(--color-text))]"
	]}
>
	<div class="mx-auto flex h-[70px] md:h-[75px] w-full max-w-[1400px] items-center justify-between gap-3 px-4">
		
		<!-- LOGO -->
		<a class="flex items-center gap-2 no-underline" href="/">
			<!-- Icon Box -->
			<span class="logo-container relative rounded-xl transition-all duration-300">
				
				<img 
				src={logoWhite.src} 
				alt="CAMS Logo Weiß" 
				class:list={[
					"logo-img logo-white absolute inset-0 m-auto object-contain transition-all duration-300",
					transparent ? "opacity-100" : "opacity-0"
				]}
			/>			

				<img 
					src={logoImg.src} 
					alt="CAMS Logo Rot" 
					class="logo-img logo-red absolute inset-0 m-auto object-contain transition-all duration-300 opacity-0"
				/>
				<img 
				src={logoSchwarz.src} 
				alt="CAMS Logo Schwarz" 
				class:list={[
					"logo-img logo-schwarz absolute inset-0 m-auto object-contain transition-all duration-300",
					transparent ? "opacity-0" : "opacity-100"
				]}
			/>	
			</span>
			
			<!-- Text -->
			<span class="leading-tight header-text-wrapper transition-all duration-300">
				<span class:list={["block text-base font-bold tracking-tight", transparent ? "text-white" : "text-[rgb(var(--color-text))]"]}>
					CAMS Ingenieure GmbH
				</span>
				<span class:list={["block text-xs", transparent ? "text-white/80" : "text-[rgb(var(--color-muted))]"]}>
					{company.officeLabel}
				</span>
			</span>
		</a>

		<!-- NAVIGATION DESKTOP -->
		<nav
			class:list={[
				"hidden rounded-full px-3 py-1.5 md:flex items-center gap-6",
				"-translate-x-17",
				transparent ? "bg-white/10 backdrop-blur-md border border-white/10" : "bg-[rgb(var(--color-surface))] border border-[rgb(var(--color-border)/0.12)]"
			]}
			aria-label="Hauptnavigation"
		>
			{company.navigation.main.map((item) => (
				<a
					class:list={[
						"px-4 py-2 rounded-full text-sm font-semibold transition-all no-underline",
						isActive(item.href)
							? (transparent ? "bg-white text-[rgb(var(--color-primary))]" : "bg-[rgb(var(--color-primary))] text-white")
							: (transparent ? "text-white hover:bg-white/20" : "text-[rgb(var(--color-muted))] hover:text-[rgb(var(--color-text))] hover:bg-[rgb(var(--color-bg))]")
					]}
					href={item.href}
					aria-current={isActive(item.href) ? 'page' : undefined}
				>
					{item.label}
				</a>
			))}
		</nav>

		<!-- RECHTE BUTTONS (CTA + Darkmode) -->
		<div class="hidden items-center gap-4 md:flex -translate-x-18 h-full">
			<!-- Darkmode Button -->
			<button
				type="button"
				class:list={[
					"h-10 w-10 flex items-center justify-center rounded-full transition-colors",
					transparent ? "bg-white/10 text-white hover:bg-white/20 border border-white/10" : "bg-[rgb(var(--color-surface))] border border-[rgb(var(--color-border)/0.12)] hover:bg-[rgb(var(--color-bg))] text-[rgb(var(--color-text))]"
				]}
				aria-label="Darkmode umschalten"
				data-theme-toggle
			>
				<span class="sr-only" data-theme-label>Zum Darkmode wechseln</span>
				<!-- Sun Icon -->
				<svg data-theme-icon-sun width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<circle cx="12" cy="12" r="5"></circle>
					<line x1="12" y1="1" x2="12" y2="3"></line>
					<line x1="12" y1="21" x2="12" y2="23"></line>
					<line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
					<line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
					<line x1="1" y1="12" x2="3" y2="12"></line>
					<line x1="21" y1="12" x2="23" y2="12"></line>
					<line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
					<line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
				</svg>
				<!-- Moon Icon -->
				<svg data-theme-icon-moon class="hidden" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
				</svg>
			</button>

			<!-- Kontakt Button -->
			<a
			class="inline-flex items-center justify-center rounded-full px-7 py-3 text-base font-bold text-[rgb(var(--color-primary))] bg-white shadow-lg transition-transform hover:scale-105 no-underline transition-transform transform-gpu"
			href={company.navigation.cta.href}
		>
			{company.navigation.cta.label}
		</a>
		</div>

		<!-- MOBILE MENU BUTTON -->
		<button 
            type="button" 
            class:list={[
                "md:hidden h-10 w-10 flex items-center justify-center rounded-full transition-colors",
                transparent ? "text-white bg-white/10 hover:bg-white/20" : "text-[rgb(var(--color-text))] bg-[rgb(var(--color-surface))] border border-[rgb(var(--color-border)/0.12)]"
            ]}
			aria-label="Menü öffnen"
            data-nav-open
        >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<line x1="3" y1="12" x2="21" y2="12"></line>
				<line x1="3" y1="6" x2="21" y2="6"></line>
				<line x1="3" y1="18" x2="21" y2="18"></line>
			</svg>
		</button>
	</div>
</header>

<!-- MOBILE OVERLAY (bleibt gleich, da es unabhängig vom Header-Style ist) -->
<div class="nav-overlay md:hidden" data-nav-overlay aria-hidden="true">
	<div class="nav-backdrop" data-nav-close aria-hidden="true"></div>
	<div class="nav-sheet" role="dialog" aria-modal="true" aria-label="Navigation">
		<div class="flex items-center justify-between">
			<div class="text-sm font-semibold text-[rgb(var(--color-text))]">{company.name}</div>
			<button type="button" class="icon-btn inline-flex items-center justify-center" aria-label="Menü schließen" data-nav-close>
				<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
					<path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
				</svg>
			</button>
		</div>

		<nav class="mt-10 grid gap-2" aria-label="Mobile Navigation">
			{company.navigation.main.map((item) => (
				<a class={`nav-mobile-link ${isActive(item.href) ? 'nav-mobile-link-active' : ''}`} href={item.href} data-nav-link>
					{item.label}
				</a>
			))}
			<a class="nav-mobile-link" href={company.navigation.cta.href} data-nav-link>
				{company.navigation.cta.label}
			</a>
		</nav>

		<div class="mt-10 grid gap-3">
			<div class="rounded-2xl border p-4 text-sm text-[rgb(var(--color-muted))]" style="border-color: rgb(var(--color-border) / 0.12);">
				<div class="text-xs font-semibold uppercase tracking-wide text-[rgb(var(--color-text))]">Kontakt</div>
				<div class="mt-2">
					<a class="no-underline hover:opacity-80" href={`tel:${company.contact.phoneHref}`}>
						{company.contact.phonec}
					</a><br>
					<a class="no-underline hover:opacity-80" href={`tel:${company.contact.phoneHref}`}>
						{company.contact.phonea}
					</a>
				</div>
				<div class="mt-1">
					<a class="no-underline hover:opacity-80" href={`mailto:${company.contact.email}`}>
						{company.contact.email}
					</a>
				</div>
			</div>

			<button type="button" class="btn btn-secondary w-full" aria-label="Darkmode umschalten" data-theme-toggle>
				<span class="sr-only" data-theme-label>Zum Darkmode wechseln</span>
				<span class="inline-flex items-center gap-2">
					<span class="text-sm font-medium" data-theme-toggle-text>Darkmode</span>
				</span>
			</button>

			<a
				class="btn btn-primary w-full"
				style="background: linear-gradient(135deg, rgb(var(--color-primary)), rgb(var(--color-accent)));"
				href={company.navigation.cta.href}
				data-nav-link
			>
				Kontakt aufnehmen
			</a>
		</div>
	</div>
</div>

<style>
	/* ... Styles für Mobile Menu (icon-btn, overlay, sheet etc.) ... */
	.icon-btn { height: 40px; width: 40px; border-radius: 14px; transition: transform 0.15s ease, opacity 0.15s ease; }
	.icon-btn:hover { opacity: 0.92; }
	.nav-overlay { position: fixed; inset: 0; z-index: 60; pointer-events: none; opacity: 0; transition: opacity 0.18s ease; }
	.nav-overlay[data-open='true'] { pointer-events: auto; opacity: 1; }
	.nav-backdrop { position: absolute; inset: 0; background: rgb(0 0 0 / 0.45); }
	.nav-sheet { position: absolute; inset: 10px; border-radius: 22px; background: rgb(var(--color-bg)); border: 1px solid rgb(var(--color-border) / 0.12); padding: 18px; transform: translateY(16px) scale(0.98); opacity: 0; transition: transform 0.18s ease, opacity 0.18s ease; box-shadow: 0 24px 80px rgb(0 0 0 / 0.25); }
	.nav-overlay[data-open='true'] .nav-sheet { transform: translateY(0) scale(1); opacity: 1; }
	.nav-mobile-link { display: flex; align-items: center; justify-content: space-between; padding: 14px 14px; border-radius: 16px; border: 1px solid rgb(var(--color-border) / 0.10); background: rgb(var(--color-surface)); color: rgb(var(--color-text)); text-decoration: none; font-size: 16px; font-weight: 600; }
	.nav-mobile-link-active { border-color: rgb(var(--color-accent) / 0.35); box-shadow: 0 0 0 3px rgb(var(--color-accent) / 0.12); }

	header.scrolled {
		background-color: rgb(var(--color-primary)) !important;
        border-bottom-color: rgba(255, 255, 255, 0.1) !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
	header.scrolled .header-text,
	header.scrolled .header-subtext,
	header.scrolled .nav-item,
	header.scrolled .theme-toggle-btn,
	header.scrolled .mobile-menu-btn {
		color: white !important;
	}
	header.scrolled .nav-container {
		background-color: transparent !important;
		border-color: transparent !important;
	}
    
	.logo-container {
        /* Layout für Zentrierung */
        display: flex; 
        align-items: center;
        justify-content: center;
        
		/* Größe & Style */
		height: 100px;
		width: 100px;
		background-color: transparent; 
		box-shadow: none;
        transition: all 0.3s ease-in-out;
	}
	.logo-img {
		height: 100%;
		width: auto;
        object-fit: contain;
        transition: all 0.3s ease-in-out;
	}

	header.scrolled .logo-container {
		/* Kleinere Größe */
		height: 60px;
		width: 60px;
        
        /* Box Style */
		background-color: 73 7 6; 
        border-radius: 12px;
	}
    
	header.scrolled .logo-img {
		height: 55px; 
	}
    
	header.scrolled > div {
        height: 70px !important; 
        transition: height 0.3s;
    }

	header:not(.scrolled) > div {
        height: 100px;
    }

	.logo-white {
    transform: scale(0.8);
    padding-top: 5px; 
}
    .logo-red {
        opacity: 0;
        transform: scale(0.8); 
		padding-top: 5px; 

    }
	header.scrolled .logo-schwarz {
    opacity: 0 !important;
    transform: scale(0.8);
}
	header.scrolled .logo-white {
		opacity: 1 !important;
		transform: scale(1);
		margin-left: 20px; 
	}
	html.dark .logo-schwarz {
		opacity: 0 !important;
	}
	html.dark .logo-white {
		opacity: 1 !important;
	}
    header.scrolled .logo-red {
        opacity: 1;
        transform: scale(1);
		margin-left: 20px; 

    }

	.header-text-wrapper {
        margin-left: -18px; 
        position: relative; 
        z-index: 10;
    }

    header.scrolled .header-text-wrapper {
        margin-left: 0px; 
    }

		/* NUR der Logo-Text wird weiß beim Scrollen */
	header.scrolled .header-text-wrapper span:first-child {
		color: white !important;
	}
	header.scrolled .header-text-wrapper span:last-child {
		color: rgba(255, 255, 255, 0.8) !important;
	}

	header.scrolled .nav-container {
		background-color: transparent !important;
		border-color: transparent !important;
	}
</style>

<script is:inline>
	/* Darkmode Logic */
	(() => {
		const storageKey = 'theme';
		const root = document.documentElement;
		const buttons = Array.from(document.querySelectorAll('[data-theme-toggle]'));
		const labels = Array.from(document.querySelectorAll('[data-theme-label]'));
		const toggleTexts = Array.from(document.querySelectorAll('[data-theme-toggle-text]'));
		const iconSuns = Array.from(document.querySelectorAll('[data-theme-icon-sun]'));
		const iconMoons = Array.from(document.querySelectorAll('[data-theme-icon-moon]'));

		const getTheme = () => (root.classList.contains('dark') ? 'dark' : 'light');
		const setTheme = (theme) => {
			root.classList.toggle('dark', theme === 'dark');
			localStorage.setItem(storageKey, theme);
			const nextLabel = theme === 'dark' ? 'Hellmodus' : 'Darkmode';
			const nextA11y = theme === 'dark' ? 'Zum Hellmodus wechseln' : 'Zum Darkmode wechseln';
			labels.forEach((el) => (el.textContent = nextA11y));
			toggleTexts.forEach((el) => (el.textContent = nextLabel));

			// show the icon for the *next* action: light->moon, dark->sun
			iconSuns.forEach(el => el.classList.toggle('hidden', theme !== 'dark'));
			iconMoons.forEach(el => el.classList.toggle('hidden', theme !== 'light'));
		};

		// initialize labels from current state (set early in Layout)
		setTheme(getTheme());

		buttons.forEach((btn) => {
			btn.addEventListener('click', () => {
				const next = getTheme() === 'dark' ? 'light' : 'dark';
				setTheme(next);
			});
		});
	})();

	const header = document.querySelector('header');
    const onScroll = () => {
        if (window.scrollY > 20) {
            header?.classList.add('scrolled');
        } else {
            header?.classList.remove('scrolled');
        }
    };
    window.addEventListener('scroll', onScroll);
    onScroll();
</script>

<script is:inline>
	/* Mobile Menu Logic */
	(() => {
		const overlay = document.querySelector('[data-nav-overlay]');
		const openBtn = document.querySelector('[data-nav-open]');
		const closeBtns = Array.from(document.querySelectorAll('[data-nav-close]'));
		const linkBtns = Array.from(document.querySelectorAll('[data-nav-link]'));

		if (!(overlay instanceof HTMLElement)) return;
		if (!(openBtn instanceof HTMLElement)) return;

		let lastActive = null;

		const setOpen = (open) => {
			overlay.dataset.open = open ? 'true' : 'false';
			overlay.setAttribute('aria-hidden', open ? 'false' : 'true');
			document.body.style.overflow = open ? 'hidden' : '';
			if (open) {
				lastActive = document.activeElement;
				const close = overlay.querySelector('[data-nav-close]');
				if (close instanceof HTMLElement) close.focus();
			} else {
				if (lastActive instanceof HTMLElement) lastActive.focus();
			}
		};

		openBtn.addEventListener('click', () => setOpen(true));
		closeBtns.forEach((b) => b.addEventListener('click', () => setOpen(false)));
		linkBtns.forEach((a) => a.addEventListener('click', () => setOpen(false)));

		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape' && overlay.dataset.open === 'true') setOpen(false);
		});

		// init closed
		setOpen(false);
	})();
</script>